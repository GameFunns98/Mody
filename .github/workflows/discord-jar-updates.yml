name: Discord notify (JAR updates)

on:
  push:
    branches: [ "main" ]
    paths:
      - "*.jar"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history = spolehlivy diff

      - name: Build Discord payload
        env:
          BEFORE: ${{ github.event.before }}
          AFTER: ${{ github.sha }}
        run: |
          python - <<'PY'
          import json, subprocess, os

          repo = os.environ["GITHUB_REPOSITORY"]
          branch = os.environ["GITHUB_REF_NAME"]
          sha = os.environ["GITHUB_SHA"]
          actor = os.environ["GITHUB_ACTOR"]
          before = (os.environ.get("BEFORE") or "").strip()
          after = (os.environ.get("AFTER") or "").strip()

          # GitHub nekdy posle BEFORE jako samy nuly (napr. prvni push)
          if not before or set(before) == {"0"}:
            diff_cmd = "git diff --name-status HEAD~1..HEAD"
          else:
            diff_cmd = f"git diff --name-status {before}..{after}"

          diff = subprocess.check_output(["bash","-lc", diff_cmd], text=True).splitlines()

          changes = []
          for line in diff:
            if not line.strip():
              continue
            status, path = line.split("\t", 1)
            status = status.strip()
            path = path.strip()
            if path.lower().endswith(".jar"):
              changes.append((status, path))

          if not changes:
            with open("payload.json","w",encoding="utf-8") as f:
              json.dump({"_skip": True}, f)
            raise SystemExit(0)

          def raw_url(p):
            return f"https://raw.githubusercontent.com/{repo}/{branch}/{p}"

          rows = []
          for status, path in changes[:15]:
            tag = {"A":"ADD", "M":"UPD", "D":"DEL"}.get(status, status)
            if status == "D":
              rows.append(f"{tag}  {path}")
            else:
              rows.append(f"{tag}  {path}\n{raw_url(path)}")

          embed = {
            "title": "Update modů (.jar) v repu",
            "description": f"Autor: {actor}\nBranch: {branch}\nCommit: {sha[:7]}",
            "url": f"https://github.com/{repo}/commit/{sha}",
            "fields": [
              {
                "name": "Změněné soubory a přímé download linky",
                "value": "\n\n".join(rows)[:1024]
              }
            ]
          }

          payload = {"username": "Mody Notifier", "embeds": [embed]}

          with open("payload.json","w",encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False)
          PY

      - name: Send to Discord webhook
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python - <<'PY'
          import json, os, sys, urllib.request, urllib.error

          webhook = (os.environ.get("DISCORD_WEBHOOK") or "").strip()
          with open("payload.json","r",encoding="utf-8") as f:
            payload = json.load(f)

          if payload.get("_skip"):
            print("No .jar changes detected. Skipping.")
            sys.exit(0)

          data = json.dumps(payload).encode("utf-8")
          req = urllib.request.Request(
            webhook,
            data=data,
            headers={"Content-Type":"application/json","User-Agent":"GitHubActions-DiscordWebhook"}
          )

          try:
            with urllib.request.urlopen(req) as r:
              print("Discord OK:", r.status)
          except urllib.error.HTTPError as e:
            print("Discord HTTPError:", e.code, e.reason)
            print(e.read().decode("utf-8", "replace"))
            raise
          PY
